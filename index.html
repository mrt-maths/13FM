<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MRT Maths Games</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:32px;background:#f5f7fb}
  h1{margin:0 0 10px}
  p{margin:0 0 18px;opacity:.75}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  a.card{display:block;text-decoration:none;color:#111;background:#fff;border:1px solid #ddd;border-radius:14px;padding:16px;transition:.15s}
  a.card:hover{transform:translateY(-3px);box-shadow:0 10px 18px rgba(0,0,0,.08)}
  .title{font-weight:700;font-size:18px;margin-bottom:6px}
  .desc{font-size:13px;opacity:.75;line-height:1.3;word-break:break-word}
  .error{background:#fff3f3;border:1px solid #ffd0d0;border-radius:12px;padding:12px}
  .toolbar{display:flex;gap:10px;align-items:center;margin:14px 0 18px;flex-wrap:wrap}
  input{padding:10px 12px;border:1px solid #ddd;border-radius:10px;min-width:260px}
  button{padding:10px 12px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
  button:hover{box-shadow:0 6px 14px rgba(0,0,0,.06)}
  .small{font-size:12px;opacity:.7}
</style>
</head>
<body>
  <h1>MRT Maths Games</h1>
  <p>Auto-generated list of HTML games in this folder (most recently updated first).</p>

  <div class="toolbar">
    <input id="q" type="search" placeholder="Search games..." aria-label="Search games">
    <button id="reload" type="button">Reload</button>
    <span class="small" id="meta"></span>
  </div>

  <div id="status"></div>
  <div class="grid" id="games"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  /* Site: https://mrt-maths.github.io/13FM/ */
  const OWNER  = "mrt-maths";
  const REPO   = "13FM";
  const BRANCH = "main";
  /* If your games are in a subfolder inside the repo, set PATH="subfolder" */
  const PATH   = "";

  const statusEl = document.getElementById("status");
  const gridEl   = document.getElementById("games");
  const qEl      = document.getElementById("q");
  const metaEl   = document.getElementById("meta");
  const reloadBtn= document.getElementById("reload");

  // Hard fail (prevents “blank page” confusion)
  if(!statusEl || !gridEl || !qEl || !metaEl || !reloadBtn){
    console.error("Index page is missing required elements.", {statusEl, gridEl, qEl, metaEl, reloadBtn});
    return;
  }

  let allFiles = []; // [{ name, updatedAt: Date|null }]

  function prettify(filename){
    return filename
      .replace(/\.html$/i,"")
      .replace(/[-_]+/g," ")
      .replace(/\b\w/g, c => c.toUpperCase());
  }

  function formatDate(d){
    if(!d) return "Unknown";
    return new Intl.DateTimeFormat(undefined, {
      year: "numeric", month: "short", day: "2-digit",
      hour: "2-digit", minute: "2-digit"
    }).format(d);
  }

  function render(list){
    if (!list.length){
      gridEl.innerHTML = "";
      statusEl.innerHTML = `<div class="error">No matching HTML files found.</div>`;
      metaEl.textContent = "";
      return;
    }
    statusEl.innerHTML = "";
    const base = PATH ? (PATH.replace(/\/+$/,"") + "/") : "";

    gridEl.innerHTML = list.map(f => `
      <a class="card" href="${base}${encodeURI(f.name)}">
        <div class="title">${prettify(f.name)}</div>
        <div class="desc">${base}${f.name}</div>
        <div class="small" style="margin-top:10px;">Updated: ${formatDate(f.updatedAt)}</div>
      </a>
    `).join("");

    const known = list.filter(x => x.updatedAt).length;
    metaEl.textContent = `${list.length} game(s) • ${known} with update dates`;
  }

  async function mapLimit(arr, limit, mapper){
    const results = new Array(arr.length);
    let i = 0;
    const workers = Array.from({length: Math.min(limit, arr.length)}, async () => {
      while(i < arr.length){
        const idx = i++;
        results[idx] = await mapper(arr[idx], idx);
      }
    });
    await Promise.all(workers);
    return results;
  }

  // Cache (reduces GitHub rate-limit pain)
  const CACHE_KEY = `mrt_index_cache:${OWNER}/${REPO}@${BRANCH}:${PATH || "/"}`;
  const CACHE_TTL_MS = 6 * 60 * 60 * 1000; // 6 hours

  function loadCache(){
    try{
      const raw = localStorage.getItem(CACHE_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.savedAt || !obj.data) return null;
      if(Date.now() - obj.savedAt > CACHE_TTL_MS) return null;
      return obj.data; // { [fullPath]: { updatedISO } }
    }catch{ return null; }
  }

  function saveCache(cacheObj){
    try{
      localStorage.setItem(CACHE_KEY, JSON.stringify({ savedAt: Date.now(), data: cacheObj }));
    }catch{}
  }

  async function fetchLatestCommitDate(fullPath, cache){
    if(cache && cache[fullPath]?.updatedISO){
      const d = new Date(cache[fullPath].updatedISO);
      return isNaN(d.getTime()) ? null : d;
    }

    const commitsApi =
      `https://api.github.com/repos/${OWNER}/${REPO}/commits` +
      `?sha=${encodeURIComponent(BRANCH)}` +
      `&path=${encodeURIComponent(fullPath)}` +
      `&per_page=1`;

    const res = await fetch(commitsApi, { headers: { "Accept": "application/vnd.github+json" }});
    if(!res.ok) throw new Error(`Commits API error ${res.status} for ${fullPath}`);
    const arr = await res.json();
    const iso = arr?.[0]?.commit?.committer?.date || arr?.[0]?.commit?.author?.date || null;
    if(!iso) return null;

    cache[fullPath] = { updatedISO: iso };
    const d = new Date(iso);
    return isNaN(d.getTime()) ? null : d;
  }

  async function load(){
    statusEl.innerHTML = `<div class="small">Loading…</div>`;
    gridEl.innerHTML = "";
    metaEl.textContent = "";

    try{
      const api = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${encodeURIComponent(BRANCH)}`;
      const res = await fetch(api, { headers: { "Accept": "application/vnd.github+json" }});
      if(!res.ok){
        throw new Error(`GitHub API error ${res.status}. Check OWNER/REPO/BRANCH/PATH and that the repo is public.`);
      }
      const items = await res.json();

      const names = items
        .filter(x => x.type === "file" && /\.html$/i.test(x.name))
        .map(x => x.name)
        .filter(n => n.toLowerCase() !== "index.html");

      if(!names.length){
        statusEl.innerHTML = `<div class="error">No other .html files found in this folder. If they’re in a subfolder, set PATH to that folder name.</div>`;
        return;
      }

      const cache = loadCache() || {};
      const base = PATH ? (PATH.replace(/\/+$/,"") + "/") : "";

      let done = 0;
      statusEl.innerHTML = `<div class="small">Fetching last-updated times… 0/${names.length}</div>`;

      const enriched = await mapLimit(names, 5, async (name) => {
        const fullPath = `${base}${name}`;
        const updatedAt = await fetchLatestCommitDate(fullPath, cache);
        done++;
        statusEl.innerHTML = `<div class="small">Fetching last-updated times… ${done}/${names.length}</div>`;
        return { name, updatedAt };
      });

      saveCache(cache);

      enriched.sort((a,b) => {
        const ta = a.updatedAt ? a.updatedAt.getTime() : -Infinity;
        const tb = b.updatedAt ? b.updatedAt.getTime() : -Infinity;
        return tb - ta; // newest first
      });

      allFiles = enriched;
      statusEl.innerHTML = "";
      render(allFiles);

    } catch(err){
      statusEl.innerHTML = `<div class="error"><b>Couldn’t load game list.</b><br>${err.message}</div>`;
    }
  }

  qEl.addEventListener("input", () => {
    const term = qEl.value.trim().toLowerCase();
    const filtered = allFiles.filter(f => f.name.toLowerCase().includes(term));
    render(filtered);
  });

  reloadBtn.addEventListener("click", () => {
    try{ localStorage.removeItem(CACHE_KEY); }catch{}
    load();
  });

  load();
});
</script>
</body>
</html>
