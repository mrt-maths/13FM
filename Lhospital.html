<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>L'Hospital's Rule – Infinite Limits</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --ink:#111; --muted:#667085;
    --ok:#16a34a; --bad:#dc2626; --line:#e5e7eb; --accent:#f97316;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:rgba(245,247,251,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
  .toprow{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .title{display:flex;gap:10px;align-items:baseline}
  h1{font-size:18px;margin:0}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px}
  .pill strong{font-variant-numeric:tabular-nums}
  main{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
  @media (max-width: 920px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 6px 20px rgba(15,23,42,.06)}
  .card h2{margin:0 0 8px;font-size:15px}
  .sub{color:var(--muted);font-size:13px;margin:0 0 10px}
  .ruleBox{padding:12px;border:1px dashed #cbd5e1;border-radius:14px;background:#fbfdff}
  .ruleLine{font-size:15px;line-height:1.7;margin:10px 0}
  .slot{
    display:inline-flex;min-width:150px;min-height:42px;
    padding:8px 12px;margin:0 6px;border-radius:14px;
    border:2px dashed #cbd5e1;background:#fff;vertical-align:middle;
    align-items:center;justify-content:center;
  }
  .slot.wide{min-width:320px}
  .slot.filled{border-style:solid}
  .slot.ok{border-color:rgba(22,163,74,.45);background:rgba(22,163,74,.07)}
  .slot.bad{border-color:rgba(220,38,38,.45);background:rgba(220,38,38,.07)}
  .bank{display:flex;flex-wrap:wrap;gap:10px}
  .tile{
    user-select:none;touch-action:none;
    display:inline-flex;align-items:center;justify-content:center;
    padding:10px 14px;border-radius:14px;border:1px solid var(--line);
    background:#fff;cursor:grab;min-width:120px;
    box-shadow:0 4px 12px rgba(15,23,42,.06);
    font-size:14px;
  }
  .tile.rect{border-radius:6px;font-weight:700}
  .tile:active{cursor:grabbing}
  .tile.disabled{opacity:.45;pointer-events:none}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{
    border:1px solid var(--line);background:#fff;border-radius:12px;
    padding:10px 12px;font-weight:700;cursor:pointer
  }
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button:disabled{opacity:.5;cursor:not-allowed}
  .msg{margin-top:10px;font-weight:800}
  .msg.ok{color:var(--ok)}
  .msg.bad{color:var(--bad)}
  .qBox{display:flex;flex-direction:column;gap:10px}
  .qMath{font-size:20px;padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:#fff}
  .ansRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input[type="text"]{
    flex:1;min-width:220px;
    padding:10px 12px;border-radius:12px;border:1px solid var(--line);
    font-size:16px
  }
  .hint{color:var(--muted);font-size:13px;margin:0}
  .small{font-size:12px;color:var(--muted)}
  .hide{display:none!important}
</style>

<script>
  window.MathJax = { tex: { inlineMath: [['\\(','\\)'],['$','$']] } };
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>

<body>
<header>
  <div class="wrap">
    <div class="toprow">
      <div class="title">
        <h1>L'Hospital's Rule – Infinite Practice</h1>
        <span class="small">Drag-drop the rule, then solve limits forever.</span>
      </div>
      <div class="pill">
        <span>Question</span>
        <strong id="qNum">1</strong>
      </div>
    </div>
  </div>
</header>

<main>
  <!-- STAGE 1 -->
  <section id="stageRule" class="grid">
    <div class="card">
      <h2>Drag and drop: L'Hospital’s Rule</h2>
      <p class="sub">Drag the tiles into the gaps. (Hold <b>Ctrl</b> and click <b>Check rule</b> to skip straight to questions.)</p>

      <div class="ruleBox">
        <div class="ruleLine">
          <strong>L'Hospital’s rule</strong> states that for two functions \(f(x)\) and \(g(x)\), if either:
        </div>

        <div class="ruleLine">
          \( \displaystyle \lim_{x\to a} f(x)=\lim_{x\to a} g(x)=\)
          <span class="slot" data-slot="s0"></span>
        </div>

        <div class="ruleLine">
          \( \displaystyle \lim_{x\to a} f(x)=\)
          <span class="slot" data-slot="s1"></span>
          and
          \( \displaystyle \lim_{x\to a} g(x)=\)
          <span class="slot" data-slot="s2"></span>
        </div>

        <div class="ruleLine">
          then provided that
          \( \displaystyle \lim_{x\to a}\frac{f'(x)}{g'(x)} \)
          <span class="slot" data-slot="s3"></span>,
          \( \displaystyle \lim_{x\to a}\frac{f(x)}{g(x)} = \)
          <span class="slot wide" data-slot="s4"></span>
        </div>
      </div>

      <div class="controls">
        <button id="ruleCheck" class="primary" title="Ctrl+Click to skip to questions">Check rule</button>
        <button id="ruleReset">Reset</button>
        <button id="startBtn" class="primary" disabled>Start questions</button>
      </div>
      <div id="ruleMsg" class="msg"></div>
    </div>

    <div class="card">
      <h2>Tile bank</h2>
      <p class="sub">Drag tiles into the gaps. (Touch-friendly.)</p>
      <div id="tileBank" class="bank"></div>
      <p class="hint">Tip: dropping onto a filled gap swaps the tiles.</p>
    </div>
  </section>

  <!-- STAGE 2 -->
  <section id="stageQ" class="grid hide">
    <div class="card">
      <h2>Limit question</h2>
      <p class="sub">Type the value of the limit. You must be correct to move on.</p>

      <div class="qBox">
        <div id="qText" class="qMath"></div>

        <div class="ansRow">
          <input id="ans" type="text" inputmode="text" autocomplete="off" placeholder="e.g. 1/2, 0, 3*sqrt(2)/4, -inf" />
          <button id="checkBtn" class="primary">Check</button>
          <button id="nextBtn" class="primary" disabled>Next</button>
        </div>

        <p class="hint">
          Accepted: fractions (<code>3/2</code>), roots (<code>sqrt(5)</code>), powers (<code>2^(1/3)</code>), and infinity (<code>inf</code>, <code>-inf</code>).
        </p>

        <div id="qMsg" class="msg"></div>
      </div>
    </div>

    <div class="card">
      <h2>How checking works</h2>
      <p class="sub">We compare your input numerically (equivalent forms are fine).</p>
      <ul class="small">
        <li><code>1</code> matches <code>2/2</code></li>
        <li><code>sqrt(8)/2</code> matches <code>sqrt(2)</code></li>
        <li>Infinity: <code>inf</code> or <code>-inf</code></li>
      </ul>
      <button id="newQuestionNow">New random question (resets current)</button>
    </div>
  </section>
</main>

<script>
/* ===== helpers to avoid (x--1) etc ===== */
function fmtShift(varName, a){
  // returns like "x-3" or "x+1"
  return (a >= 0) ? `${varName}-${a}` : `${varName}+${-a}`;
}
function parenShift(varName, a){
  return `(${fmtShift(varName, a)})`;
}
function fmtLin(A, B){
  // Ax + B with nice signs (A can be -1, 1 etc)
  const Ax = (A === 1) ? 'x' : (A === -1) ? '-x' : `${A}x`;
  const signB = (B >= 0) ? `+${B}` : `${B}`;
  return `(${Ax}${signB})`;
}

/* =========================
   TOUCH-FRIENDLY DRAG/DROP
   ========================= */
function makeDraggable(el){
  let ghost = null;

  const onDown = (e) => {
    if(el.classList.contains('disabled')) return;
    e.preventDefault();
    const pt = (e.touches && e.touches[0]) ? e.touches[0] : e;

    ghost = el.cloneNode(true);
    ghost.style.position = 'fixed';
    ghost.style.left = pt.clientX + 'px';
    ghost.style.top = pt.clientY + 'px';
    ghost.style.transform = 'translate(-50%, -50%)';
    ghost.style.zIndex = 9999;
    ghost.style.pointerEvents = 'none';
    ghost.style.opacity = '0.92';
    document.body.appendChild(ghost);

    window.addEventListener('mousemove', onMove, {passive:false});
    window.addEventListener('mouseup', onUp, {passive:false});
    window.addEventListener('touchmove', onMove, {passive:false});
    window.addEventListener('touchend', onUp, {passive:false});
  };

  const onMove = (e) => {
    if(!ghost) return;
    e.preventDefault();
    const pt = (e.touches && e.touches[0]) ? e.touches[0] : e;
    ghost.style.left = pt.clientX + 'px';
    ghost.style.top = pt.clientY + 'px';
  };

  const onUp = (e) => {
    if(!ghost) return;
    e.preventDefault();
    const pt = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e;
    const target = document.elementFromPoint(pt.clientX, pt.clientY);
    const slot = target ? target.closest('.slot') : null;
    if(slot){
      placeTileIntoSlot(el, slot);
    }
    document.body.removeChild(ghost);
    ghost = null;

    window.removeEventListener('mousemove', onMove);
    window.removeEventListener('mouseup', onUp);
    window.removeEventListener('touchmove', onMove);
    window.removeEventListener('touchend', onUp);
  };

  el.addEventListener('mousedown', onDown, {passive:false});
  el.addEventListener('touchstart', onDown, {passive:false});
}

function placeTileIntoSlot(tileEl, slotEl){
  const existing = slotEl.querySelector('.tile');
  if(existing){
    document.getElementById('tileBank').appendChild(existing);
    existing.classList.remove('disabled');
  }
  slotEl.innerHTML = '';
  slotEl.appendChild(tileEl);
  slotEl.classList.add('filled');
  tileEl.classList.add('disabled');
}

/* =========================
   STAGE 1: RULE D&D
   ========================= */
const ruleTiles = [
  {id:'t0',     html:'0'},
  {id:'tPmInf1',html:'\\(\\pm\\infty\\)'},
  {id:'tPmInf2',html:'\\(\\pm\\infty\\)'},
  {id:'tExists',html:'exists'},
  {id:'tFinal', html:'\\(\\displaystyle \\lim_{x\\to a}\\frac{f\\\'(x)}{g\\\'(x)}\\)', rect:true},
];

const ruleAnswer = { s0:'t0', s1:'tPmInf1', s2:'tPmInf2', s3:'tExists', s4:'tFinal' };

function buildRuleTiles(){
  const bank = document.getElementById('tileBank');
  bank.innerHTML = '';
  ruleTiles.forEach(t=>{
    const d = document.createElement('div');
    d.className='tile' + (t.rect ? ' rect' : '');
    d.dataset.tileId = t.id;
    d.innerHTML = t.html;
    bank.appendChild(d);
    makeDraggable(d);
  });

  document.querySelectorAll('.slot').forEach(s=>{
    s.innerHTML='';
    s.classList.remove('filled','ok','bad');
  });

  setRuleMsg('');
  document.getElementById('startBtn').disabled = true;
  if(window.MathJax?.typesetPromise) MathJax.typesetPromise();
}

function setRuleMsg(text, ok=null){
  const el = document.getElementById('ruleMsg');
  el.textContent = text || '';
  el.className = 'msg' + (ok===true ? ' ok' : ok===false ? ' bad' : '');
}

function checkRule(){
  let allGood = true;
  const pmInfSet = new Set(['tPmInf1','tPmInf2']);

  document.querySelectorAll('.slot').forEach(slot=>{
    const key = slot.dataset.slot;
    const expected = ruleAnswer[key];
    const tile = slot.querySelector('.tile');
    const got = tile ? tile.dataset.tileId : null;

    slot.classList.remove('ok','bad');

    let ok = false;
    if(key === 's1' || key === 's2') ok = got && pmInfSet.has(got);
    else ok = got && got === expected;

    if(ok) slot.classList.add('ok');
    else { slot.classList.add('bad'); allGood = false; }
  });

  if(allGood){
    setRuleMsg('Correct — you can start the questions.', true);
    document.getElementById('startBtn').disabled = false;
  }else{
    setRuleMsg('Not quite — fix the highlighted gaps.', false);
    document.getElementById('startBtn').disabled = true;
  }
  return allGood;
}

function goToQuestions(){
  document.getElementById('stageRule').classList.add('hide');
  document.getElementById('stageQ').classList.remove('hide');
  qIndex = 1;
  renderQuestion(makeQuestion());
}

/* =========================
   STAGE 2: INFINITE LIMITS
   ========================= */
function evalUserExpr(s){
  if(!s) return NaN;
  s = s.trim().toLowerCase();
  if(['inf','+inf','infty','infinity','+infinity'].includes(s)) return Infinity;
  if(['-inf','-infty','-infinity'].includes(s)) return -Infinity;

  const safe = s.replaceAll('π','pi').replaceAll('^','**').replaceAll('ln','log');
  if(/[^0-9a-z+\-*/().,_\s**]/i.test(safe)) return NaN;

  const pi = Math.PI, e = Math.E;
  const sqrt = Math.sqrt, abs = Math.abs, sin = Math.sin, cos = Math.cos, tan = Math.tan;
  const atan = Math.atan, log = Math.log, exp = Math.exp, pow = Math.pow;

  try{
    // eslint-disable-next-line no-new-func
    const f = new Function('pi','e','sqrt','abs','sin','cos','tan','atan','log','exp','pow', `return (${safe});`);
    const v = f(pi,e,sqrt,abs,sin,cos,tan,atan,log,exp,pow);
    return (typeof v === 'number') ? v : NaN;
  }catch(_){ return NaN; }
}

function nearlyEqual(a,b){
  if(!Number.isFinite(a) && !Number.isFinite(b)) return (a===b);
  if(!Number.isFinite(a) || !Number.isFinite(b)) return false;
  const diff = Math.abs(a-b);
  const scale = Math.max(1, Math.abs(a), Math.abs(b));
  return diff <= 1e-6 * scale;
}

let qIndex = 1;
let current = null;
let canNext = false;

function randint(lo,hi){ return Math.floor(Math.random()*(hi-lo+1))+lo; }
function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function makeQuestion(){
  const templates = [];

  templates.push(()=>{
    const a = choice([4,9,16,25]);
    const k = choice([2,3,4,5,6,8,10]);
    const q = `\\(\\displaystyle \\lim_{x\\to ${a}} \\frac{x-${a}}{${k}(\\sqrt{x}-${Math.sqrt(a)})}\\)`;
    const ans = (2*Math.sqrt(a))/k;
    return {latex:q, ans};
  });

  templates.push(()=>{
    let m = randint(2,9), n = randint(2,9);
    while(n===m) n = randint(2,9);
    const q = `\\(\\displaystyle \\lim_{x\\to 0} \\frac{\\arctan(${m}x)}{\\arctan(${n}x)}\\)`;
    return {latex:q, ans:m/n};
  });

  templates.push(()=>{
    const p = choice([2,3,4]);
    const q = `\\(\\displaystyle \\lim_{x\\to \\infty} \\frac{\\ln x}{x^{${p}}}\\)`;
    return {latex:q, ans:0};
  });

  templates.push(()=>{
    const a = choice([1,1,2,3]);
    const b = choice([1,2,3]);
    const q = `\\(\\displaystyle \\lim_{x\\to 0} \\frac{\\sin^{2}(${a}x)}{x\\tan(${b}x)}\\)`;
    return {latex:q, ans:(a*a)/b};
  });

  templates.push(()=>{
    const c = choice([1,1,2,3]);
    const d = choice([1,2,3]);
    const q = `\\(\\displaystyle \\lim_{x\\to 0} \\frac{x^{2}e^{${c}x}}{\\tan^{2}(${d}x)}\\)`;
    return {latex:q, ans:1/(d*d)};
  });

  templates.push(()=>{
    const k = choice([1,2,3,4]);
    const q = `\\(\\displaystyle \\lim_{x\\to 0^+} \\ln\\big(x\\sin(${k}x)\\big)\\)`;
    return {latex:q, ans:-Infinity};
  });

  templates.push(()=>{
    const q = `\\(\\displaystyle \\lim_{x\\to 0} \\frac{e^{x}-1-x}{x^{2}}\\)`;
    return {latex:q, ans:0.5};
  });

  templates.push(()=>{
    const k = choice([1,4,9,16,25,36]);
    const q = `\\(\\displaystyle \\lim_{x\\to ${k}} \\frac{\\sqrt{x}-\\sqrt{${k}}}{\\sqrt[3]{x}-\\sqrt[3]{${k}}}\\)`;
    return {latex:q, ans:1.5*Math.pow(k, 1/6)};
  });

  // UPDATED to avoid (x--1): uses parenShift('x', a)
  templates.push(()=>{
    const a = choice([-3,-2,-1,1,2,3,4]);
    const A = randint(-5,5)||2;
    const B = randint(-8,8);
    const C = randint(-5,5)||-3;
    const D = randint(-8,8);
    const xa = parenShift('x', a); // (x-3) or (x+1)
    const q = `\\(\\displaystyle \\lim_{x\\to ${a}} \\frac{${xa}${fmtLin(A,B)}}{${xa}${fmtLin(C,D)}}\\)`;
    return {latex:q, ans:(A*a+B)/(C*a+D)};
  });

  return choice(templates)();
}

function setQMsg(text, ok=null){
  const el = document.getElementById('qMsg');
  el.textContent = text || '';
  el.className = 'msg' + (ok===true ? ' ok' : ok===false ? ' bad' : '');
}

function renderQuestion(q){
  current = q;
  canNext = false;
  document.getElementById('nextBtn').disabled = true;
  document.getElementById('ans').value = '';
  setQMsg('');
  document.getElementById('qText').innerHTML = q.latex;
  document.getElementById('qNum').textContent = String(qIndex);
  if(window.MathJax?.typesetPromise) MathJax.typesetPromise();
}

function checkAnswer(){
  const raw = document.getElementById('ans').value.trim();
  const userV = evalUserExpr(raw);
  const ansV = current.ans;

  if(Number.isNaN(userV)){
    setQMsg("I couldn't read that. Try e.g. 3/2, sqrt(2), 0, inf, -inf.", false);
    return;
  }

  const ok = nearlyEqual(userV, ansV);
  if(ok){
    setQMsg('Correct ✓', true);
    canNext = true;
    document.getElementById('nextBtn').disabled = false;
  }else{
    setQMsg('Not correct — try again.', false);
    canNext = false;
    document.getElementById('nextBtn').disabled = true;
  }
}

function nextQuestion(){
  if(!canNext) return;
  qIndex += 1;
  renderQuestion(makeQuestion());
}

/* =========================
   WIRING
   ========================= */
document.getElementById('ruleCheck').addEventListener('click', (e)=>{
  if(e.ctrlKey){ goToQuestions(); return; }
  checkRule();
});
document.getElementById('ruleReset').addEventListener('click', buildRuleTiles);
document.getElementById('startBtn').addEventListener('click', goToQuestions);

document.getElementById('checkBtn').addEventListener('click', checkAnswer);
document.getElementById('nextBtn').addEventListener('click', nextQuestion);
document.getElementById('ans').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    if(!canNext) checkAnswer();
    else nextQuestion();
  }
});
document.getElementById('newQuestionNow').addEventListener('click', ()=>renderQuestion(makeQuestion()));

buildRuleTiles();
</script>
</body>
</html>
